stages:
  - test
  - scan

default:
  image: python:3.11-slim

variables:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PYTHONDONTWRITEBYTECODE: "1"
  PYTHONUNBUFFERED: "1"

before_script:
  - python --version
  - pip install -r requirements.txt --quiet

unit_tests:
  stage: test
  script:
    - python -m pytest tests/ -v --tb=short
  rules:
    - when: always

hermes_clew_scan:
  stage: scan
  script:
    - python -m scan.scanner demo-app/ > hermes_clew_scan_results.json
    - python -c "import json; json.load(open('hermes_clew_scan_results.json')); print('scan JSON valid')"
  artifacts:
    when: always
    paths:
      - hermes_clew_scan_results.json
    expire_in: 7 days
  rules:
    - when: always